# ğŸ§¬ LysoData-Miner Production Deployment Makefile
# =================================================

.PHONY: help prod-up prod-down prod-build prod-restart prod-logs prod-status prod-backup prod-clean

# Colors
BLUE := \033[34m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# Docker Compose file
COMPOSE_FILE := docker-compose.production.yml
ENV_FILE := .env.production

help: ## Show production deployment commands
	@echo "$(BLUE)ğŸ§¬ LysoData-Miner Production Deployment$(RESET)"
	@echo "$(BLUE)====================================$(RESET)"
	@echo ""
	@echo "$(GREEN)Quick Commands:$(RESET)"
	@echo "  make prod-up      # ğŸš€ Start all services (build if needed)"
	@echo "  make prod-down    # ğŸ›‘ Stop all services"
	@echo "  make prod-restart # ğŸ”„ Restart all services"
	@echo "  make prod-status  # ğŸ“Š Show services status"
	@echo "  make prod-logs    # ğŸ“‹ Show live logs"
	@echo "  make prod-backup  # ğŸ’¾ Create database backup"
	@echo ""
	@echo "$(GREEN)Available commands:$(RESET)"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##/ { printf "  $(YELLOW)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)

# Check environment file
check-env:
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "$(YELLOW)âš ï¸  $(ENV_FILE) not found, copying from example...$(RESET)"; \
		cp env.production.example $(ENV_FILE); \
		echo "$(GREEN)âœ… Created $(ENV_FILE) - please review and update passwords!$(RESET)"; \
	fi

# Production commands
prod-up: check-env ## ğŸš€ Start all production services
	@echo "$(BLUE)ğŸš€ Starting LysoData-Miner in production mode...$(RESET)"
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) up -d --build
	@echo ""
	@echo "$(GREEN)âœ… Services starting up!$(RESET)"
	@echo "$(YELLOW)ğŸ“Š Frontend: http://localhost:$$(grep WEB_PORT $(ENV_FILE) | cut -d'=' -f2 || echo 3000)$(RESET)"
	@echo "$(YELLOW)ğŸ”Œ Backend API: http://localhost:8000$(RESET)"
	@echo "$(YELLOW)ğŸ—„ï¸  Database: localhost:$$(grep DB_PORT $(ENV_FILE) | cut -d'=' -f2 || echo 5434)$(RESET)"
	@echo ""
	@echo "$(BLUE)ğŸ’¡ Use 'make prod-logs' to see initialization progress$(RESET)"

prod-down: ## ğŸ›‘ Stop all production services
	@echo "$(BLUE)ğŸ›‘ Stopping LysoData-Miner production services...$(RESET)"
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) down
	@echo "$(GREEN)âœ… Services stopped$(RESET)"

prod-build: ## ğŸ—ï¸ Build all Docker images
	@echo "$(BLUE)ğŸ—ï¸ Building LysoData-Miner Docker images...$(RESET)"
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) build --no-cache
	@echo "$(GREEN)âœ… Build completed$(RESET)"

prod-restart: ## ğŸ”„ Restart all production services
	@echo "$(BLUE)ğŸ”„ Restarting LysoData-Miner production services...$(RESET)"
	@$(MAKE) prod-down
	@sleep 2
	@$(MAKE) prod-up

prod-logs: ## ğŸ“‹ Show live logs from all services
	@echo "$(BLUE)ğŸ“‹ Showing LysoData-Miner production logs...$(RESET)"
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) logs -f

prod-logs-backend: ## ğŸ“‹ Show backend logs only
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) logs -f backend

prod-logs-frontend: ## ğŸ“‹ Show frontend logs only
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) logs -f frontend

prod-logs-init: ## ğŸ“‹ Show initialization logs
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) logs data-init

prod-status: ## ğŸ“Š Show services status and health
	@echo "$(BLUE)ğŸ“Š LysoData-Miner Production Status$(RESET)"
	@echo "$(BLUE)================================$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸ³ Docker Services:$(RESET)"
	@docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) ps
	@echo ""
	@echo "$(GREEN)ğŸ¥ Health Checks:$(RESET)"
	@echo -n "Backend API: "
	@curl -sf http://localhost:8000/api/health/ >/dev/null && echo "$(GREEN)âœ… Healthy$(RESET)" || echo "$(RED)âŒ Not responding$(RESET)"
	@echo -n "Frontend: "
	@WEB_PORT=$$(grep WEB_PORT $(ENV_FILE) | cut -d'=' -f2 || echo 3000); \
	curl -sf http://localhost:$$WEB_PORT >/dev/null && echo "$(GREEN)âœ… Healthy$(RESET)" || echo "$(RED)âŒ Not responding$(RESET)"
	@echo -n "Database: "
	@DB_PORT=$$(grep DB_PORT $(ENV_FILE) | cut -d'=' -f2 || echo 5434); \
	docker exec lysodata_db pg_isready -U lysobacter_user -d lysobacter_db >/dev/null 2>&1 && echo "$(GREEN)âœ… Healthy$(RESET)" || echo "$(RED)âŒ Not responding$(RESET)"

prod-backup: ## ğŸ’¾ Create database backup
	@echo "$(BLUE)ğŸ’¾ Creating database backup...$(RESET)"
	@mkdir -p ./backups
	@BACKUP_FILE="./backups/backup_$$(date +%Y%m%d_%H%M%S).sql.gz"
	@docker exec lysodata_db pg_dump -U lysobacter_user lysobacter_db | gzip > $$BACKUP_FILE
	@echo "$(GREEN)âœ… Backup created: $$BACKUP_FILE$(RESET)"

prod-stats: ## ğŸ“Š Show database statistics
	@echo "$(BLUE)ğŸ“Š Database Statistics$(RESET)"
	@echo "$(BLUE)==================$(RESET)"
	@docker exec lysodata_db psql -U lysobacter_user -d lysobacter_db -c "
		SELECT 
		  'Strains: ' || COUNT(*) as stats FROM lysobacter.strains
		UNION ALL
		SELECT 
		  'Categories: ' || COUNT(*) FROM lysobacter.test_categories
		UNION ALL
		SELECT 
		  'Tests: ' || COUNT(*) FROM lysobacter.tests
		UNION ALL
		SELECT 
		  'Boolean results: ' || COUNT(*) FROM lysobacter.test_results_boolean
		UNION ALL
		SELECT 
		  'Numeric results: ' || COUNT(*) FROM lysobacter.test_results_numeric;
	" -t

prod-shell-db: ## ğŸ’» Connect to database shell
	@echo "$(BLUE)ğŸ’» Connecting to database shell...$(RESET)"
	docker exec -it lysodata_db psql -U lysobacter_user -d lysobacter_db

prod-shell-backend: ## ğŸ’» Connect to backend container shell
	@echo "$(BLUE)ğŸ’» Connecting to backend container...$(RESET)"
	docker exec -it lysodata_api sh

prod-shell-frontend: ## ğŸ’» Connect to frontend container shell
	@echo "$(BLUE)ğŸ’» Connecting to frontend container...$(RESET)"
	docker exec -it lysodata_web sh

prod-clean: ## ğŸ§¹ Clean up Docker resources
	@echo "$(BLUE)ğŸ§¹ Cleaning up Docker resources...$(RESET)"
	docker-compose -f $(COMPOSE_FILE) --env-file $(ENV_FILE) down -v --rmi all --remove-orphans
	@echo "$(GREEN)âœ… Cleanup completed$(RESET)"

prod-reset: ## ğŸ”„ Full reset - stop, clean, rebuild, start
	@echo "$(BLUE)ğŸ”„ Full production reset...$(RESET)"
	@$(MAKE) prod-down
	@$(MAKE) prod-clean
	@$(MAKE) prod-build
	@$(MAKE) prod-up
	@echo "$(GREEN)âœ… Full reset completed$(RESET)"

# Initialize from existing backup
prod-restore: ## ğŸ”„ Restore database from backup (BACKUP_FILE=path/to/backup.sql.gz)
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "$(RED)âŒ Please specify BACKUP_FILE variable$(RESET)"; \
		echo "$(YELLOW)Example: make prod-restore BACKUP_FILE=./backups/backup_20250629_120000.sql.gz$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ”„ Restoring database from $(BACKUP_FILE)...$(RESET)"
	@gunzip -c $(BACKUP_FILE) | docker exec -i lysodata_db psql -U lysobacter_user -d lysobacter_db
	@echo "$(GREEN)âœ… Database restored$(RESET)" 