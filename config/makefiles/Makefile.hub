# üê≥ LysoData-Miner Docker Hub Management Makefile
# 
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏, –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ Docker Hub

.PHONY: help build-images push-images hub-deploy hub-status hub-logs hub-clean

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BLUE=\033[0;34m
GREEN=\033[0;32m
YELLOW=\033[1;33m
RED=\033[0;31m
NC=\033[0m # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
DOCKER_HUB_USER = gimmyhat
VERSION ?= latest

help: ## üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
	@echo -e "$(BLUE)üê≥ LysoData-Miner Docker Hub Management$(NC)"
	@echo -e "$(BLUE)=====================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)üì¶ –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(build|push|images)' | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo -e "$(GREEN)üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(hub|deploy)' | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo -e "$(GREEN)üîß –£—Ç–∏–ª–∏—Ç—ã:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -vE '(build|push|images|hub|deploy)' | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo -e "$(BLUE)üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:$(NC)"
	@echo "  make build-images VERSION=v1.0.0    # –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã —Å –≤–µ—Ä—Å–∏–µ–π"
	@echo "  make push-images                    # –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑—ã"
	@echo "  make hub-deploy                     # –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å Docker Hub"
	@echo "  make hub-status                     # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"

# ========================
# üì¶ –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è
# ========================

build-images: ## üèóÔ∏è –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã –ª–æ–∫–∞–ª—å–Ω–æ
	@echo -e "$(BLUE)üèóÔ∏è –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è Docker Hub...$(NC)"
	@echo -e "$(YELLOW)üì¶ –í–µ—Ä—Å–∏—è: $(VERSION)$(NC)"
	@echo -e "$(YELLOW)üë§ Docker Hub: $(DOCKER_HUB_USER)$(NC)"
	@echo ""
	./scripts/build_and_push.sh --help
	@echo ""
	@echo -e "$(GREEN)üîÑ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏...$(NC)"
	./scripts/build_and_push.sh $(VERSION) --no-push

push-images: ## üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑—ã –Ω–∞ Docker Hub
	@echo -e "$(BLUE)üì§ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤ –Ω–∞ Docker Hub...$(NC)"
	./scripts/build_and_push.sh $(VERSION)

build-and-push: ## üöÄ –°–æ–±—Ä–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑—ã (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)
	@echo -e "$(BLUE)üöÄ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Å–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è$(NC)"
	./scripts/build_and_push.sh $(VERSION)

# ========================
# üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
# ========================

hub-deploy: ## üåê –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–∏—Å—Ç–µ–º—É —Å Docker Hub –æ–±—Ä–∞–∑–∞–º–∏
	@echo -e "$(BLUE)üåê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ LysoData-Miner —Å Docker Hub$(NC)"
	./scripts/deploy_hub.sh start

hub-stop: ## üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
	@echo -e "$(BLUE)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ LysoData-Miner$(NC)"
	./scripts/deploy_hub.sh stop

hub-restart: ## üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
	@echo -e "$(BLUE)üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ LysoData-Miner$(NC)"
	./scripts/deploy_hub.sh restart

hub-status: ## üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
	@echo -e "$(BLUE)üìä –°—Ç–∞—Ç—É—Å LysoData-Miner$(NC)"
	./scripts/deploy_hub.sh status

hub-logs: ## üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
	@echo -e "$(BLUE)üìã –õ–æ–≥–∏ LysoData-Miner$(NC)"
	./scripts/deploy_hub.sh logs

hub-pull: ## ‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑—ã —Å Docker Hub
	@echo -e "$(BLUE)‚¨áÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ —Å Docker Hub$(NC)"
	./scripts/deploy_hub.sh pull

hub-clean: ## üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã
	@echo -e "$(BLUE)üßπ –û—á–∏—Å—Ç–∫–∞ LysoData-Miner$(NC)"
	@echo -e "$(RED)‚ö†Ô∏è  –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ!$(NC)"
	./scripts/deploy_hub.sh clean

# ========================
# üîß –£—Ç–∏–ª–∏—Ç—ã
# ========================

check-images: ## üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑—ã
	@echo -e "$(BLUE)üîç –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑—ã LysoData-Miner:$(NC)"
	@echo ""
	@docker images | grep -E "(gimmyhat/lysodata|REPOSITORY)" || echo -e "$(YELLOW)‚ö†Ô∏è  –û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"

check-hub: ## üåê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–∑—ã –Ω–∞ Docker Hub
	@echo -e "$(BLUE)üåê –û–±—Ä–∞–∑—ã –Ω–∞ Docker Hub:$(NC)"
	@echo ""
	@echo -e "$(YELLOW)üîó Backend:$(NC)  https://hub.docker.com/r/$(DOCKER_HUB_USER)/lysodata-backend"
	@echo -e "$(YELLOW)üîó Frontend:$(NC) https://hub.docker.com/r/$(DOCKER_HUB_USER)/lysodata-frontend"
	@echo ""
	@echo -e "$(BLUE)üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...$(NC)"
	@docker manifest inspect $(DOCKER_HUB_USER)/lysodata-backend:latest >/dev/null 2>&1 && \
		echo -e "$(GREEN)‚úÖ Backend –æ–±—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–µ–Ω$(NC)" || \
		echo -e "$(RED)‚ùå Backend –æ–±—Ä–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"
	@docker manifest inspect $(DOCKER_HUB_USER)/lysodata-frontend:latest >/dev/null 2>&1 && \
		echo -e "$(GREEN)‚úÖ Frontend –æ–±—Ä–∞–∑ –¥–æ—Å—Ç—É–ø–µ–Ω$(NC)" || \
		echo -e "$(RED)‚ùå Frontend –æ–±—Ä–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"

login-hub: ## üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Docker Hub
	@echo -e "$(BLUE)üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub$(NC)"
	docker login

info: ## ‚ÑπÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
	@echo -e "$(BLUE)üß¨ LysoData-Miner Project Information$(NC)"
	@echo -e "$(BLUE)====================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)üê≥ Docker Hub Account:$(NC) $(DOCKER_HUB_USER)"
	@echo -e "$(GREEN)üì¶ Backend Image:$(NC)     $(DOCKER_HUB_USER)/lysodata-backend"
	@echo -e "$(GREEN)üì¶ Frontend Image:$(NC)    $(DOCKER_HUB_USER)/lysodata-frontend"
	@echo -e "$(GREEN)üè∑Ô∏è  Current Version:$(NC)   $(VERSION)"
	@echo ""
	@echo -e "$(GREEN)üîó URLs:$(NC)"
	@echo "   Backend Hub:  https://hub.docker.com/r/$(DOCKER_HUB_USER)/lysodata-backend"
	@echo "   Frontend Hub: https://hub.docker.com/r/$(DOCKER_HUB_USER)/lysodata-frontend"
	@echo ""
	@echo -e "$(GREEN)üìÇ Configuration Files:$(NC)"
	@echo "   docker-compose.hub.yml  - Compose file for Hub deployment"
	@echo "   env.hub.example         - Environment configuration template"
	@echo "   scripts/build_and_push.sh  - Build and push automation"
	@echo "   scripts/deploy_hub.sh       - Deployment automation"

version: ## üè∑Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
	@echo -e "$(BLUE)üè∑Ô∏è Current version: $(GREEN)$(VERSION)$(NC)"

# ========================
# üéØ –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
# ========================

quick-deploy: hub-deploy ## ‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–∞–ª–∏–∞—Å –¥–ª—è hub-deploy)

all: build-and-push hub-deploy ## üéØ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Å–±–æ—Ä–∫–∞ ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è ‚Üí —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
	@echo ""
	@echo -e "$(GREEN)üéâ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω!$(NC)"
	@echo -e "$(YELLOW)üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: make hub-status$(NC)"

# ========================
# üìù Remote deployment
# ========================

remote-files: ## üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
	@echo -e "$(BLUE)üìÅ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞$(NC)"
	@mkdir -p deploy-package
	@cp docker-compose.hub.yml deploy-package/
	@cp env.hub.example deploy-package/.env
	@cp scripts/deploy_hub.sh deploy-package/
	@chmod +x deploy-package/deploy_hub.sh
	@if [ ! -f deploy-package/README_REMOTE.md ]; then \
		echo "# LysoData-Miner Remote Deployment" > deploy-package/README_REMOTE.md; \
		echo "–î–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Å–º. .env —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ./deploy_hub.sh --help" >> deploy-package/README_REMOTE.md; \
	fi
	@echo ""
	@echo -e "$(GREEN)‚úÖ –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã –≤ –ø–∞–ø–∫–µ deploy-package/:$(NC)"
	@ls -la deploy-package/
	@echo ""
	@echo -e "$(YELLOW)üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:$(NC)"
	@echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞–ø–∫—É deploy-package/ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
	@echo "2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª (–ø–∞—Ä–æ–ª–∏, –ø–æ—Ä—Ç—ã)"
	@echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ./deploy_hub.sh"
	@echo "4. –°–º. README_REMOTE.md –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π"

clean-package: ## üßπ –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É deploy-package
	@echo -e "$(BLUE)üßπ –£–¥–∞–ª–µ–Ω–∏–µ deploy-package/$(NC)"
	@rm -rf deploy-package/
	@echo -e "$(GREEN)‚úÖ –ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞$(NC)" 